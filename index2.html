<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معسكر حفظ القرآن الكريم</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
        }
        
        body {
            font-family: 'Tajawal', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2, #80deea, #4dd0e1, #26c6da, #00bcd4, #00acc1, #0097a7);
            color: #333;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-color));
            color: white;
            padding: 30px 20px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 10px 0 0;
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .nav {
            background-color: var(--dark-color);
            display: flex;
            justify-content: center;
            padding: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 8px;
            border-radius: 30px;
            transition: all 0.3s ease;
            font-weight: 500;
            display: flex;
            align-items: center;
        }
        
        .nav a:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }
        
        .nav a i {
            margin-left: 8px;
        }
        
        .container {
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin: 25px auto;
            padding: 25px;
            max-width: 1200px;
            border: 1px solid rgba(52, 152, 219, 0.2);
        }
        
        h2 {
            color: var(--primary-color);
            border-bottom: 2px solid var(--light-color);
            padding-bottom: 10px;
            margin-top: 0;
            display: flex;
            align-items: center;
        }
        
        h2 i {
            margin-left: 10px;
        }
        
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 20px;
            overflow: hidden;
            background-color: white;
            border-radius: 8px;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
            vertical-align: middle;
        }
        
        tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border 0.3s;
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button i {
            margin-left: 8px;
        }
        
        /* Progress Visualization */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            flex-grow: 1;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(90deg, #4dd0e1, #26c6da, #00bcd4, #0097a7);
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 30px 30px;
            animation: animate-stripes 2s linear infinite;
        }
        
        @keyframes animate-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 60px 0; }
        }
        
        .progress-value {
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        /* Circular Progress */
        .circular-progress {
            position: relative;
            width: 60px;
            height: 60px;
            margin: 0 auto;
        }
        
        .circular-progress svg {
            width: 100%;
            height: 100%;
        }
        
        .circular-progress circle {
            fill: none;
            stroke-width: 6;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        .circular-progress-bg {
            stroke: #f0f0f0;
        }
        
        .circular-progress-fill {
            stroke: url(#progressGradient);
            stroke-dasharray: 188;
            stroke-dashoffset: calc(188 - (188 * var(--progress)) / 100);
            transition: stroke-dashoffset 0.8s ease;
        }
        
        .circular-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        /* Badges for Groups */
        .group-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .group-a { background-color: #e3f2fd; color: #1976d2; }
        .group-b { background-color: #e8f5e9; color: #388e3c; }
        .group-c { background-color: #fff3e0; color: #f57c00; }
        .group-d { background-color: #fce4ec; color: #c2185b; }
        
        /* Excel Connection Buttons */
        .excel-btn {
            background-color: #107c41;
            margin-left: 10px;
        }
        
        .excel-btn:hover {
            background-color: #0e6b38;
        }
        
        /* Competition Section Styles */
        .competition-section {
            margin-top: 40px;
        }
        
        .competition-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .trophy-icon {
            color: gold;
            font-size: 2rem;
            margin-left: 10px;
        }
        
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .leaderboard-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            padding: 12px 15px;
            transition: transform 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .leaderboard-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        
        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            width: 40px;
            text-align: center;
            color: var(--dark-color);
        }
        
        .rank-1 { color: gold; }
        .rank-2 { color: silver; }
        .rank-3 { color: #cd7f32; } /* bronze */
        
        .student-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        .student-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .student-group {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Bar Chart Visualization */
        .bar-chart {
            margin-top: 30px;
        }
        
        .chart-container {
            height: 300px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            padding: 20px 0;
            border-bottom: 1px solid #ddd;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }
        
        .chart-bar {
            width: 40px;
            background: linear-gradient(to top, #00bcd4, #0097a7);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: height 0.8s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chart-bar:hover {
            opacity: 0.9;
            transform: scaleY(1.05);
        }
        
        .chart-label {
            position: absolute;
            bottom: -25px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: var(--dark-color);
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            width: 100%;
            text-align: center;
            font-weight: bold;
        }
        
        /* Medals Distribution */
        .medals-distribution {
            display: flex;
            justify-content: space-around;
            margin-top: 30px;
            text-align: center;
        }
        
        .medal-card {
            padding: 15px;
            border-radius: 10px;
            width: 30%;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background-color: rgba(255, 255, 255, 0.8);
        }
        
        .gold { border-top: 3px solid gold; }
        .silver { border-top: 3px solid silver; }
        .bronze { border-top: 3px solid #cd7f32; }
        
        .medal-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        /* SVG Gradient for Circular Progress */
        svg.defs-only {
            position: absolute;
            height: 0;
            width: 0;
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden;
        }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background-color: var(--success-color);
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.error {
            background-color: var(--danger-color);
        }
        
        .toast.warning {
            background-color: var(--warning-color);
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            body {
                background: linear-gradient(135deg, #e0f7fa, #b2ebf2, #80deea);
            }
            
            .nav {
                flex-wrap: wrap;
                padding: 8px;
            }
            
            .nav a {
                padding: 8px 12px;
                margin: 4px;
                font-size: 14px;
            }
            
            .container {
                padding: 15px;
                margin: 15px;
            }
            
            table {
                display: block;
                overflow-x: auto;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .chart-bar {
                width: 25px;
            }
            
            .medals-distribution {
                flex-direction: column;
                align-items: center;
            }
            
            .medal-card {
                width: 80%;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- SVG Gradient Definition -->
    <svg class="defs-only">
        <defs>
            <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#4dd0e1" />
                <stop offset="100%" stop-color="#0097a7" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <div class="header">
        <h1><i class="fas fa-mosque"></i> معسكر حفظ القرآن الكريم</h1>
        <p>متابعة الحفظ الجديد ومراجعة البيت</p>
    </div>
    
    <div class="nav">
        <a href="#home"><i class="fas fa-home"></i> الرئيسية</a>
        <a href="#new"><i class="fas fa-book-quran"></i> الحفظ الجديد</a>
        <a href="#review"><i class="fas fa-house-user"></i> المراجعة</a>
        <a href="#add"><i class="fas fa-user-plus"></i> إضافة طالبة</a>
        <a href="#test"><i class="fas fa-pen-fancy"></i> تسجيل التسميع</a>
        <a href="#competition"><i class="fas fa-trophy"></i> المسابقة</a>
    </div>
    
    <div id="home" class="container">
        <h2><i class="fas fa-table"></i> لوحة متابعة الطالبات</h2>
        <button id="load-excel" class="excel-btn"><i class="fas fa-file-excel"></i> تحميل البيانات من Excel</button>
        <button id="export-excel" class="excel-btn"><i class="fas fa-download"></i> تصدير البيانات</button>
        <table>
            <thead>
                <tr>
                    <th>اسم الطالبة</th>
                    <th>المجموعة</th>
                    <th>الحفظ الجديد (المعسكر)</th>
                    <th>المراجعة (البيت)</th>
                    <th>التقدم</th>
                    <th>ملاحظات</th>
                    <th>إجراءات</th>
                </tr>
            </thead>
            <tbody id="students-table-body">
                <!-- Data will be loaded here from localStorage -->
            </tbody>
        </table>
    </div>
    
    <div id="add" class="container">
        <h2><i class="fas fa-user-plus"></i> إضافة طالبة جديدة</h2>
        <form id="add-student-form">
            <div class="form-group">
                <label for="new-student-name"><i class="fas fa-user"></i> اسم الطالبة:</label>
                <input id="new-student-name" type="text" placeholder="أدخل اسم الطالبة كاملاً" required>
            </div>
            <div class="form-group">
                <label for="new-student-group"><i class="fas fa-users"></i> المجموعة:</label>
                <select id="new-student-group" required>
                    <option value="">اختر المجموعة</option>
                    <option value="أ">أ</option>
                    <option value="ب">ب</option>
                    <option value="ج">ج</option>
                    <option value="د">د</option>
                </select>
            </div>
            <div class="form-group">
                <label for="new-student-start"><i class="fas fa-book-open"></i> بداية الحفظ:</label>
                <input id="new-student-start" type="text" placeholder="مثال: البقرة (1-10)" required>
            </div>
            <div class="form-group">
                <label for="new-student-review"><i class="fas fa-undo"></i> المراجعة الحالية:</label>
                <input id="new-student-review" type="text" placeholder="مثال: الفاتحة، البقرة (1-20)">
            </div>
            <div class="form-group">
                <label for="new-student-notes"><i class="fas fa-sticky-note"></i> ملاحظات أولية:</label>
                <textarea id="new-student-notes" rows="3" placeholder="أي ملاحظات حول الطالبة"></textarea>
            </div>
            <button type="submit"><i class="fas fa-save"></i> إضافة الطالبة</button>
        </form>
    </div>
    
    <div id="test" class="container">
        <h2><i class="fas fa-pen-fancy"></i> تسجيل تسميع جديد</h2>
        <form id="test-form">
            <div class="form-group">
                <label for="student"><i class="fas fa-user"></i> اسم الطالبة:</label>
                <select id="student" required>
                    <option value="">اختر الطالبة</option>
                    <!-- Options will be loaded from localStorage -->
                </select>
            </div>
            <div class="form-group">
                <label for="type"><i class="fas fa-tasks"></i> نوع التسميع:</label>
                <select id="type" required>
                    <option value="">اختر نوع التسميع</option>
                    <option value="new">حفظ جديد (المعسكر)</option>
                    <option value="review">مراجعة (البيت)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="surah"><i class="fas fa-quran"></i> السورة/الآيات:</label>
                <input id="surah" type="text" placeholder="مثال: البقرة (1-10)" required>
            </div>
            <div class="form-group">
                <label for="date"><i class="fas fa-calendar-alt"></i> تاريخ التسميع:</label>
                <input id="date" type="date" required>
            </div>
            <div class="form-group">
                <label for="evaluation"><i class="fas fa-star"></i> التقييم:</label>
                <select id="evaluation" required>
                    <option value="">اختر التقييم</option>
                    <option value="excellent">ممتاز</option>
                    <option value="good">جيد</option>
                    <option value="needs_improvement">يحتاج تحسين</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes"><i class="fas fa-comment"></i> ملاحظات:</label>
                <textarea id="notes" rows="3" placeholder="ملاحظات حول التسميع"></textarea>
            </div>
            <button type="submit"><i class="fas fa-check-circle"></i> حفظ البيانات</button>
        </form>
    </div>

    <div id="competition" class="container">
        <div class="competition-section">
            <div class="competition-header">
                <h2><i class="fas fa-trophy trophy-icon"></i> لوحة المنافسة بين الطالبات</h2>
                <button id="refresh-competition"><i class="fas fa-sync-alt"></i> تحديث البيانات</button>
            </div>
            
            <div class="leaderboard">
                <h3><i class="fas fa-list-ol"></i> ترتيب الطالبات حسب التقدم</h3>
                <div id="leaderboard-list">
                    <!-- Leaderboard will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="bar-chart">
                <h3><i class="fas fa-chart-bar"></i> مقارنة التقدم</h3>
                <div class="chart-container" id="progress-chart">
                    <!-- Chart bars will be added by JavaScript -->
                </div>
            </div>
            
            <div class="medals-distribution">
                <div class="medal-card gold">
                    <i class="fas fa-medal medal-icon" style="color: gold;"></i>
                    <h4>المركز الأول</h4>
                    <p id="gold-medalist">-</p>
                    <p class="progress-value">-</p>
                </div>
                <div class="medal-card silver">
                    <i class="fas fa-medal medal-icon" style="color: silver;"></i>
                    <h4>المركز الثاني</h4>
                    <p id="silver-medalist">-</p>
                    <p class="progress-value">-</p>
                </div>
                <div class="medal-card bronze">
                    <i class="fas fa-medal medal-icon" style="color: #cd7f32;"></i>
                    <h4>المركز الثالث</h4>
                    <p id="bronze-medalist">-</p>
                    <p class="progress-value">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <script>
        // Data structure for students
        let students = [];
        let tests = [];
        
        // DOM elements
        const studentsTableBody = document.getElementById('students-table-body');
        const studentSelect = document.getElementById('student');
        const addStudentForm = document.getElementById('add-student-form');
        const testForm = document.getElementById('test-form');
        const toast = document.getElementById('toast');
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupEventListeners();
            
            // Set today's date as default for test date
            document.getElementById('date').valueAsDate = new Date();
        });
        
        // Load data from localStorage
        function loadData() {
            const savedStudents = localStorage.getItem('quranStudents');
            const savedTests = localStorage.getItem('quranTests');
            
            if (savedStudents) {
                students = JSON.parse(savedStudents);
                updateStudentsTable();
                updateStudentDropdown();
            }
            
            if (savedTests) {
                tests = JSON.parse(savedTests);
            }
            
            // If no data, load sample data
            if (students.length === 0) {
                loadSampleData();
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('quranStudents', JSON.stringify(students));
            localStorage.setItem('quranTests', JSON.stringify(tests));
        }
        
        // Load sample data for initial display
        function loadSampleData() {
            students = [
                {
                    id: Date.now(),
                    name: "فاطمة أحمد",
                    group: "أ",
                    currentMemorization: "البقرة (1-10)",
                    currentReview: "الفاتحة",
                    progress: 90,
                    notes: "ممتازة"
                },
                {
                    id: Date.now() + 1,
                    name: "آية محمد",
                    group: "ب",
                    currentMemorization: "آل عمران (1-5)",
                    currentReview: "البقرة (1-50)",
                    progress: 85,
                    notes: "جيدة جدًا"
                },
                {
                    id: Date.now() + 2,
                    name: "سارة خالد",
                    group: "ج",
                    currentMemorization: "النساء (1-7)",
                    currentReview: "آل عمران (1-20)",
                    progress: 78,
                    notes: "تحتاج متابعة"
                },
                {
                    id: Date.now() + 3,
                    name: "هناء علي",
                    group: "أ",
                    currentMemorization: "المائدة (1-5)",
                    currentReview: "النساء (1-10)",
                    progress: 72,
                    notes: "ممتازة"
                },
                {
                    id: Date.now() + 4,
                    name: "نورا سعيد",
                    group: "د",
                    currentMemorization: "الأنعام (1-10)",
                    currentReview: "المائدة (1-8)",
                    progress: 65,
                    notes: "جيدة"
                }
            ];
            
            saveData();
            updateStudentsTable();
            updateStudentDropdown();
        }
        
        // Update students table
        function updateStudentsTable() {
            studentsTableBody.innerHTML = '';
            
            students.forEach(student => {
                const groupClass = `group-${student.group.toLowerCase()}`;
                const newRow = studentsTableBody.insertRow();
                
                newRow.innerHTML = `
                    <td>${student.name}</td>
                    <td><span class="group-badge ${groupClass}">${student.group}</span></td>
                    <td>${student.currentMemorization}</td>
                    <td>${student.currentReview || '-'}</td>
                    <td>
                        <div class="circular-progress" style="--progress: ${student.progress}">
                            <svg viewBox="0 0 64 64">
                                <circle class="circular-progress-bg" cx="32" cy="32" r="30"></circle>
                                <circle class="circular-progress-fill" cx="32" cy="32" r="30"></circle>
                            </svg>
                            <div class="circular-progress-text">${student.progress}%</div>
                        </div>
                    </td>
                    <td>${student.notes || '-'}</td>
                    <td>
                        <button class="edit-student" data-id="${student.id}" title="تعديل"><i class="fas fa-edit"></i></button>
                        <button class="delete-student" data-id="${student.id}" title="حذف"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                
                // Initialize circular progress
                const progressEl = newRow.querySelector('.circular-progress');
                const progress = progressEl.style.getPropertyValue('--progress') || 0;
                const fill = progressEl.querySelector('.circular-progress-fill');
                if (fill) {
                    const circumference = 2 * Math.PI * 30;
                    const offset = circumference - (progress / 100) * circumference;
                    fill.style.strokeDashoffset = offset;
                }
            });
            
            // Update competition view
            updateCompetitionView();
        }
        
        // Update student dropdown
        function updateStudentDropdown() {
            studentSelect.innerHTML = '<option value="">اختر الطالبة</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                studentSelect.appendChild(option);
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Add student form
            addStudentForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const newStudent = {
                    id: Date.now(),
                    name: document.getElementById('new-student-name').value,
                    group: document.getElementById('new-student-group').value,
                    currentMemorization: document.getElementById('new-student-start').value,
                    currentReview: document.getElementById('new-student-review').value || '',
                    progress: 0,
                    notes: document.getElementById('new-student-notes').value || ''
                };
                
                students.push(newStudent);
                saveData();
                updateStudentsTable();
                updateStudentDropdown();
                
                showToast('تمت إضافة الطالبة بنجاح');
                addStudentForm.reset();
            });
            
            // Test form
            testForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const studentId = document.getElementById('student').value;
                const student = students.find(s => s.id == studentId);
                
                if (!student) {
                    showToast('الرجاء اختيار طالبة', 'error');
                    return;
                }
                
                const newTest = {
                    id: Date.now(),
                    studentId: studentId,
                    studentName: student.name,
                    type: document.getElementById('type').value,
                    surah: document.getElementById('surah').value,
                    date: document.getElementById('date').value,
                    evaluation: document.getElementById('evaluation').value,
                    notes: document.getElementById('notes').value || ''
                };
                
                tests.push(newTest);
                saveData();
                
                // Update student progress based on test
                if (newTest.type === 'new') {
                    student.currentMemorization = newTest.surah;
                    // Simple progress calculation (for demo purposes)
                    student.progress = Math.min(100, student.progress + 5);
                } else if (newTest.type === 'review') {
                    student.currentReview = newTest.surah;
                }
                
                saveData();
                updateStudentsTable();
                updateCompetitionView();
                
                showToast('تم تسجيل التسميع بنجاح');
                testForm.reset();
                document.getElementById('date').valueAsDate = new Date();
            });
            
            // Load Excel button
            document.getElementById('load-excel').addEventListener('click', function() {
                document.getElementById('excel-file-input').click();
            });
            
            // Export Excel button
            document.getElementById('export-excel').addEventListener('click', exportToExcel);
            
            // Refresh competition button
            document.getElementById('refresh-competition').addEventListener('click', function() {
                updateCompetitionView();
                showToast('تم تحديث بيانات المسابقة');
            });
            
            // Excel file input
            const excelFileInput = document.createElement('input');
            excelFileInput.type = 'file';
            excelFileInput.id = 'excel-file-input';
            excelFileInput.accept = '.csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel';
            excelFileInput.style.display = 'none';
            document.body.appendChild(excelFileInput);
            
            excelFileInput.addEventListener('change', handleExcelImport);
            
            // Delegated event listeners for edit/delete buttons
            studentsTableBody.addEventListener('click', function(e) {
                if (e.target.closest('.edit-student')) {
                    const studentId = parseInt(e.target.closest('.edit-student').dataset.id);
                    editStudent(studentId);
                }
                
                if (e.target.closest('.delete-student')) {
                    const studentId = parseInt(e.target.closest('.delete-student').dataset.id);
                    deleteStudent(studentId);
                }
            });
        }
        
        // Edit student
        function editStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            // Fill the form with student data
            document.getElementById('new-student-name').value = student.name;
            document.getElementById('new-student-group').value = student.group;
            document.getElementById('new-student-start').value = student.currentMemorization;
            document.getElementById('new-student-review').value = student.currentReview;
            document.getElementById('new-student-notes').value = student.notes;
            
            // Change form to edit mode
            addStudentForm.dataset.editing = studentId;
            addStudentForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> حفظ التعديلات';
            
            // Scroll to form
            document.querySelector('#add').scrollIntoView({ behavior: 'smooth' });
            
            // Change form submit behavior
            addStudentForm.onsubmit = function(e) {
                e.preventDefault();
                
                student.name = document.getElementById('new-student-name').value;
                student.group = document.getElementById('new-student-group').value;
                student.currentMemorization = document.getElementById('new-student-start').value;
                student.currentReview = document.getElementById('new-student-review').value;
                student.notes = document.getElementById('new-student-notes').value;
                
                saveData();
                updateStudentsTable();
                updateStudentDropdown();
                updateCompetitionView();
                
                showToast('تم تحديث بيانات الطالبة بنجاح');
                
                // Reset form
                addStudentForm.reset();
                delete addStudentForm.dataset.editing;
                addStudentForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> إضافة الطالبة';
                addStudentForm.onsubmit = null;
            };
        }
        
        // Delete student
        function deleteStudent(studentId) {
            if (confirm('هل أنت متأكد من حذف هذه الطالبة؟ سيتم حذف جميع بياناتها بما في ذلك سجل التسميع.')) {
                students = students.filter(s => s.id !== studentId);
                tests = tests.filter(t => t.studentId !== studentId);
                saveData();
                updateStudentsTable();
                updateStudentDropdown();
                updateCompetitionView();
                
                showToast('تم حذف الطالبة بنجاح');
            }
        }
        
        // Competition Visualization Functions
        function updateCompetitionView() {
            // Sort students by progress (descending)
            const sortedStudents = [...students].sort((a, b) => b.progress - a.progress);

            // Update Leaderboard
            const leaderboardList = document.getElementById('leaderboard-list');
            leaderboardList.innerHTML = '';
            
            sortedStudents.forEach((student, index) => {
                const rankClass = index < 3 ? `rank-${index + 1}` : '';
                
                const item = document.createElement('div');
                item.className = 'leaderboard-item';
                item.innerHTML = `
                    <div class="rank ${rankClass}">${index + 1}</div>
                    <div class="student-info">
                        <div class="student-name">${student.name}</div>
                        <div class="student-group">المجموعة ${student.group}</div>
                    </div>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${student.progress}%"></div>
                        </div>
                        <div class="progress-value">${student.progress}%</div>
                    </div>
                `;
                leaderboardList.appendChild(item);
            });

            // Update Bar Chart
            updateBarChart(sortedStudents.slice(0, 10)); // Show top 10 students

            // Update Medalists
            if (sortedStudents.length > 0) {
                document.getElementById('gold-medalist').textContent = sortedStudents[0].name;
                document.querySelector('.gold .progress-value').textContent = `${sortedStudents[0].progress}%`;
                
                if (sortedStudents.length > 1) {
                    document.getElementById('silver-medalist').textContent = sortedStudents[1].name;
                    document.querySelector('.silver .progress-value').textContent = `${sortedStudents[1].progress}%`;
                }
                
                if (sortedStudents.length > 2) {
                    document.getElementById('bronze-medalist').textContent = sortedStudents[2].name;
                    document.querySelector('.bronze .progress-value').textContent = `${sortedStudents[2].progress}%`;
                }
            }
        }

        function updateBarChart(topStudents) {
            const chartContainer = document.getElementById('progress-chart');
            chartContainer.innerHTML = '';
            
            topStudents.forEach(student => {
                const barHeight = (student.progress / 100) * 100; // Percentage of chart height
                
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.height = `${barHeight}%`;
                bar.innerHTML = `
                    <div class="chart-value">${student.progress}%</div>
                    <div class="chart-label">${student.name.split(' ')[0]}</div>
                `;
                
                chartContainer.appendChild(bar);
            });
        }
        
        // Handle Excel import
        function handleExcelImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    // Parse CSV/Excel file
                    Papa.parse(e.target.result, {
                        header: true,
                        complete: function(results) {
                            if (results.data && results.data.length > 0) {
                                // Clear existing data
                                students = [];
                                
                                // Process each row
                                results.data.forEach(row => {
                                    if (row['اسم الطالبة']) {
                                        students.push({
                                            id: Date.now() + Math.floor(Math.random() * 1000),
                                            name: row['اسم الطالبة'],
                                            group: row['المجموعة'] || 'أ',
                                            currentMemorization: row['الحفظ الجديد (المعسكر)'] || '',
                                            currentReview: row['المراجعة (البيت)'] || '',
                                            progress: parseInt(row['التقدم']) || 0,
                                            notes: row['ملاحظات'] || ''
                                        });
                                    }
                                });
                                
                                saveData();
                                updateStudentsTable();
                                updateStudentDropdown();
                                updateCompetitionView();
                                
                                showToast(`تم استيراد ${students.length} طالبة بنجاح`);
                            }
                        },
                        error: function(error) {
                            console.error('Error parsing Excel file:', error);
                            showToast('حدث خطأ أثناء قراءة الملف', 'error');
                        }
                    });
                } catch (error) {
                    console.error('Error processing Excel file:', error);
                    showToast('حدث خطأ أثناء معالجة الملف', 'error');
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; // Reset file input
        }
        
        // Export to Excel
        function exportToExcel() {
            if (students.length === 0) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // Prepare data for export
            const exportData = students.map(student => ({
                'اسم الطالبة': student.name,
                'المجموعة': student.group,
                'الحفظ الجديد (المعسكر)': student.currentMemorization,
                'المراجعة (البيت)': student.currentReview,
                'التقدم': student.progress,
                'ملاحظات': student.notes
            }));
            
            // Convert to CSV
            const csv = Papa.unparse(exportData);
            
            // Create and download file
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            saveAs(blob, `طلاب_حفظ_القرآن_${new Date().toLocaleDateString('ar-EG')}.csv`);
            
            showToast('تم تصدير البيانات بنجاح');
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            toast.textContent = message;
            toast.className = 'toast';
            
            if (type === 'error') {
                toast.classList.add('error');
            } else if (type === 'warning') {
                toast.classList.add('warning');
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>